<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Shuttr</title>
    <link
      rel="stylesheet"
      href="{{ url_for('shuttr.static', filename='css/style.css') }}"
    />
    <script src="{{ url_for('shuttr.static', filename='js/thumbhash.js') }}"></script>
    <script>
      // prettier-ignore
      const layouts = [
        // [
        //   [1,1],[1,1],[1,1],
        //   [1,1],[1,1],[1,1],
        //   [1,1],[1,1],[1,1],
        //   [1,1],[1,1],[1,1],
        //   [1,1],[1,1],[1,1],
        // ],
        [
          [2,2],      [1,1],
                      [1,1],
          [1,1],[1,1],[1,1],
          [1,1],[1,2]      ,
          [1,1],[1,1],[1,1],
        ],
        [
          [1,1],      [3,2],
          [1,1]            ,
          [1,1]            ,
          [1,1],[1,1],[1,1],
          [1,1],[1,1],[1,1],
        ],
        [
          [1,1],      [2,2],
          [1,1]            ,
          [1,1],[1,1],[1,1],
          [2,2],      [1,1],
                      [1,1],
        ],
        [
          [2,3]            ,
                           
          [1,1],[1,1],[1,1],
          [1,1],      [2,2],
          [1,1]            ,
        ],
        [
          [1,1],[1,2]      ,
          [1,1],[1,1],[1,1],
          [2,2],      [1,1],
                      [1,1],
          [1,1],[1,1],[1,1],
        ],
      ];
      // const forcedLayout = 5;
      const forcedLayout = undefined;
      const layout =
        forcedLayout !== undefined
          ? layouts[forcedLayout]
          : layouts[Math.floor(Math.random() * layouts.length)];

      const shuffle = (array) => {
        let currentIndex = array.length;

        while (currentIndex != 0) {
          let randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex--;

          [array[currentIndex], array[randomIndex]] = [
            array[randomIndex],
            array[currentIndex],
          ];
        }
      };
    </script>
  </head>

  <body>
    <div>
      <h1 id="title"></h1>
      <h2 id="dates"></h2>
    </div>

    <div id="grid"></div>

    <script type="text/javascript">
      const album = {{ album|tojson|safe }};
      const baseDomain = {{ base_domain|tojson|safe }};
      document.getElementById("title").innerHTML = album.title;

      const startDate = new Date(album.startDate);
      const endDate = new Date(album.endDate);
      let formattedDate = startDate.toLocaleDateString("nl-NL", { year: 'numeric', month: 'long', day: 'numeric' })
      if(startDate.getTime() !== endDate.getTime()) {
        formattedDate += " - ";
        formattedDate += endDate.toLocaleDateString("nl-NL", { year: 'numeric', month: 'long', day: 'numeric' });
      }
      document.getElementById("dates").innerHTML = formattedDate;

      let currentPhoto = 0;
      const grid = document.getElementById("grid");
      const photos = album.photos;
      shuffle(photos);

      for (let i = 0; i < layout.length; i++) {
        const photo = photos[currentPhoto];
        const [height, width] = layout[i];
        dataUrl = thumbHashToDataURL(Uint8Array.from(atob(photo['thumbHash']), c => c.charCodeAt(0)));

        const img = document.createElement("img");
        img.setAttribute("src", `${baseDomain}/photo/${photo.album}/${photo.id}/large`);
        img.setAttribute("style", `grid-row: span ${height};grid-column: span ${width};background-image: url(${dataUrl})`);
        grid.appendChild(img);

        currentPhoto++;
        currentPhoto %= photos.length;
      }

      const swapImage = () => {
        const photo = photos[currentPhoto];
        const img = grid.children[Math.floor(Math.random() * grid.children.length)];
        img.setAttribute("src", `${baseDomain}/photo/${photo.album}/${photo.id}/large`);
        currentPhoto++;
        currentPhoto %= photos.length;
      }

      setInterval(swapImage, 2500);
      setInterval(swapImage, 3800);
    </script>
  </body>
</html>
